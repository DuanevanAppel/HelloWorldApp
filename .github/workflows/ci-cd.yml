name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.x'

      - name: Install dependencies
        run: dotnet restore
        working-directory: ./HelloWorldApp

      - name: Build
        run: dotnet build --configuration Release --no-restore
        working-directory: ./HelloWorldApp

      - name: Test
        run: dotnet test --no-build --verbosity normal
        working-directory: ./HelloWorldApp

      - name: Deploy
        run: echo "Deploy stage - Add your deploy commands here"

  notify:
    runs-on: ubuntu-latest
    needs: build
    if: failure()  # This step runs only if the build fails

    steps:
      - name: Send failure notification to Discord
        uses: actions/github-script@v6
        with:
          script: |
            const fetch = require('node-fetch');
            const webhookUrl = process.env.DISCORD_WEBHOOK_URL;
            const message = {
              content: "ðŸš¨ CI/CD Pipeline Failed! ðŸš¨\n\nThe CI/CD pipeline has failed. Please check the logs for more details.",
            };

            fetch(webhookUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(message),
            }).then(res => {
              if (!res.ok) {
                throw new Error(`Failed to send message: ${res.statusText}`);
              }
              console.log('Notification sent successfully.');
            }).catch(err => {
              console.error('Error sending notification:', err);
            });
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
